<html>
    <!-- Define metadata and links for webpage -->
    <head>
        <!-- Define character set (this page uses UTF=8 arrows) -->
        <meta charset="UTF-8">
        <!-- Include latest Vue JS CDN (as of writing) -->
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <!-- TODO: What does this do...? -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Include latest Bootstrap CSS CDN (as of writing) -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous">
        <!-- Set the tab's name in the web browser-->
        <title>Squirt Web View</title>
    </head>

    <!-- Define contents for webpage -->
    <body>
        <!-- Create container for Vue JS to mount to -->
        <div class="container" id="app" style="max-width: 500px">
            <!-- Create title on webpage -->
            <h1 class="h1">Squirt Web UI</h1>
            <!-- Create container to hold Squirt controls and output -->
            <div class="row border" id="ui">
                <div class="col" id="buttons">
                    <!-- Create button to submit up button press -->
                    <button class="btn btn-secondary" id="up" @click="e_button_click">&#11165;</button>
                    <br/>
                    <!-- Create button to submit confirm button press -->
                    <button class="btn btn-secondary" id="confirm" @click="e_button_click">&#11166;</button>
                    <br/>
                    <!-- Create button to submit down button press -->
                    <button class="btn btn-secondary" id="down" @click="e_button_click">&#11167;</button>
                </div>
                <div class="col" id="output">
                    <!-- Create text area to display Squirt response -->
                    <textarea class="font-monospace" 
                        id="response"
                        :cols="display_width"
                        :rows="display_height"
                        style="background-color: var(--bs-body-color); color: var(--bs-body-bg);">
                        {{response}}
                    </textarea>
                </div>
            </div>
            <!-- Create container to collect user settings -->
            <div class="row border" id="details">
                <!-- Create text to show currrent connection status -->
                <p>
                    Connection at 
                    <span class="font-monospace">{{ip_address}}:{{port}}</span> - 
                    <span class="text-danger" id="status">NOT CONNECTED</span>.
                </p>
                <!-- Create text input for user to set IP address to connect to -->
                <div class="form-floating">
                    <input class="form-control" type="text" id="ip_address" :value="ip_address"/>
                    <label for="ip_address">IP address: </span>
                </div>
                <!-- Create text input for user to set port to connect to -->
                <div class="form-floating">
                    <input class="form-control" type="number" id="port" :value="port"/>
                    <label for="port">Port: </label>
                </div>
                <!-- Create text input for user to set display width -->
                <div class="form-floating">
                    <input class="form-control" type="number" id="display_width" :value="display_width"/>
                    <label for="dislpay_width">Display # columns: </label>
                </div>
                <!-- Create text input for user to set display height -->
                <div class="form-floating">
                    <input class="form-control" type="number" id="display_height" :value="display_height"/>
                    <label for="display_height">Display # rows: </label>
                </div>
                <!-- Create button for uuser to submit their settings and have them take effect -->
                <button class="btn btn-primary" @click="e_button_submit_settings">Submit</button>
            </div>
        </div>
    </body>
    <!-- Include latest BootStrap JS (as of writing) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <!-- Define Vue JS functionality -->
    <script>
        // Create function to return a value from local storage, if it doesn't exist, a default value
        function get_local_storage(local_storage_item_name, default_value)
        {
            const local_storage_value = localStorage.getItem(local_storage_item_name);
            return (local_storage_value == null) ? default_value : local_storage_value;
        }

        // Create a Vue JS app to mount to the prior HTML (from an object, defined by {})
        const app = Vue.createApp({

            // Define the data of this Vue app in an object storing key-value pairs
            data() {
                // Return members
                return {
                    response: "Hello world!",
                    is_connection_success: false,
                    websocket: null,
                    ip_address: get_local_storage("ip_address", "127.0.0.1"),
                    port: get_local_storage("port", "1234"),
                    display_height: get_local_storage("display_height", "4"),
                    display_width: get_local_storage("display_width", "20"),
                };
            },

            // Define the methods of this Vue app in an object storing an array
            methods: {

                // Define function for submitting user settings
                e_button_submit_settings(event){
                    // Save relevant previous state
                    const prev_ip_address = this.ip_address;
                    const prev_port = this.port;
                    
                    // Get element values from DOM
                    this.ip_address = document.getElementById("ip_address").value;
                    this.port = document.getElementById("port").value;
                    this.display_height = document.getElementById("display_height").value;
                    this.display_width = document.getElementById("display_width").value;

                    // Log for debugging
                    console.log(`ip_address: (${typeof(this.ip_address)}) ${this.ip_address}`);
                    console.log(`port: (${typeof(this.port)}) ${this.port}`);
                    console.log(`display_height: (${typeof(this.display_height)}): ${this.display_height}`);
                    console.log(`display_width: (${typeof(this.display_width)}): ${this.display_width}`);

                    // Update class members in persistent memory
                    localStorage.setItem("ip_address", this.ip_address);
                    localStorage.setItem("port", this.port);
                    localStorage.setItem("display_width", this.display_width);
                    localStorage.setItem("display_height", this.display_height);

                    // Update websocket if necessary
                    if((this.websocket == null) || (this.websocket.readyState == WebSocket.CLOSED) || (this.ip_address != prev_ip_address) || (this.port != prev_port))
                    {
                        // Close existing websocket
                        if(this.websocket != null)
                        {
                            this.websocket.close();
                        }

                        // Create new websocket
                        // TODO: Somehow access members from event handlers instead of using document.getElementById?
                        //       Would I need globals linked by reference? Ew.
                        this.websocket = new WebSocket(`ws://${this.ip_address}:${this.port}`);
                        document.getElementById("status").innerText = "IN PROGRESS";
                        document.getElementById("status").className = "text-warning";
                        this.websocket.addEventListener("open", (event) => {
                            console.log(event);
                            document.getElementById("status").innerText = "CONNECTED";
                            document.getElementById("status").className = "text-success";
                        });
                        this.websocket.addEventListener("error", (event) => {
                            console.log(event);
                            document.getElementById("status").innerText = "ERROR (see web console)";
                            document.getElementById("status").className = "text-danger";
                        });
                        this.websocket.addEventListener("message", (event) => {
                            console.log(event);
                            document.getElementById("response").innerText = event.data;
                        });
                        
                        console.log(this.websocket);
                    }
                },

                // Define functionality for clicking input buttons
                e_button_click(event){
                    // Log event for debugging
                    console.log(event);

                    // If there is no websocket to send traffic over, don't bother, and tell user
                    if((this.websocket == null) || (this.websocket.readyState != WebSocket.OPEN))
                    {
                        alert("Invalid websocket. Please submit a valid IP address and port.");
                        return;
                    }

                    // Send the ID of the triggering element
                    this.websocket.send(event.target.id);
                },

            },

        });
    
        // Connect Vue app to HTML app.
        app.mount("#app");

    </script>
</html>